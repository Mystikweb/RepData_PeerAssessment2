---
title: "Impact of Severe Weather Events in the U.S."
subtitle: "Coursera Reproducible Research Peer Assessment 2"
author: "Christopher Hair"
date: "June 24, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Synopsis
As part of the [Coursera Reproducible Research Course](https://www.coursera.org/learn/reproducible-research), the final peer assessment project is to explore the affects of severe weather events on a population's health and economy. In this article, we examine what the impact of different types of weather events have had in the United States. We will look at the total number of injuries and fatalities along with the total cost of damages incurred for each type of event and determine which has had the greatest overall impact. The information used for the analysis comes from data collected by the U.S. National Oceanic and Atmospheric Administration (NOAA) between 1950 and 2011. All of the artifacts used in the construction of this article can be found in the [Reproducible Research Peer Assessment 2](https://github.com/Mystikweb/RepData_PeerAssessment2) repository located on [GitHub](https://github.com).

## Data Processing
### Importing Packages
```{r package_import, message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(huxtable)
```
### Preparing The Data
The snapshot data file for this course is located in the repository's "data" folder as a CSV file compressed using the bzip2 algoritm. To start analyzing the information we need load the data into the environment and look at the structure.
```{r data_read, cache=TRUE}
raw_data <- read.csv("data/repdata_data_StormData.csv.bz2")
str(raw_data)
```
From the structure of the data we can determine that the following variables are required to perform this analysis:

Variable    | Description
------------|--------------------------------------------------------------------
EVTYPE      | The weather event type
FATALITIES  | The number of fatlaities due to the event
INJURIES    | The number of injuries dure to the event
PROPDMG     | The amount of property damages due to the event
PROPDMGEXP  | The exponential amount of the property damage (i.e. M is millions)
CROPDMG     | The amount of crop damages due to the event
CROPDMGEXP  | The exponential amount of the crop damage (i.e. K is thousands)


### Impact on Health
Using the required variables we can analyze the total injuries and fatalities to determine what types of severe weather events have had the greatest impact on the United States. For both the number of injuries and the number of fatalities by event type we can perform the following operations:

1. Group the raw data by the type of event
2. Get the total number of events for each type of event
3. Get the average amount the variable that was reported
4. Get the total amount of the variable that was reported
5. Limit the results to any events that have been reported more than 100 times

Once the previous operations are performed for both the injuries and the fatalities we can combine both datasets and reduce the results even more using the rules listed below and calculating the total amounts.

1. Take only results that have an average amount of each variable is more than 1
2. The total amount of each variable is not the same as the average amount of each variable

```{r build_health_data, message=FALSE}
event_injuries <- raw_data %>%
    group_by(EVTYPE) %>%
    summarise(total_events = n(),
              avg_injuries = mean(INJURIES),
              total_injuries = sum(INJURIES)) %>%
    filter(total_events > 100) %>%
    select(event_type = EVTYPE, 
           total_events, 
           avg_injuries, 
           total_injuries)

event_fatalities <- raw_data %>%
    group_by(EVTYPE) %>%
    summarise(total_events = n(),
              avg_fatalities = mean(FATALITIES),
              total_fatalities = sum(FATALITIES)) %>%
    filter(total_events > 100) %>%
    select(event_type = EVTYPE, 
           total_events, 
           avg_fatalities, 
           total_fatalities)

health_data <- event_injuries %>%
    inner_join(event_fatalities) %>%
    filter((avg_injuries > 1 & avg_fatalities != 0) | 
               (avg_fatalities > 1 & avg_injuries != 0)) %>%
    filter(avg_injuries != total_injuries & 
               avg_fatalities != total_fatalities) %>%
    select(event_type, 
           total_events, 
           total_injuries, 
           total_fatalities)
```

### Health Related Totals
Using this data we can get the total number of injuries and fatalities for each of the combined events. This shows that tornados have the highest rate of injuries and fatalities of the other events.
```{r health_table}
health_table <- as_hux(health_data %>% 
                       mutate(total_health_related = total_injuries + total_fatalities) %>%
                       arrange(desc(total_health_related)) %>%
                       select("Event Type" = event_type, 
                              "Total Events" = total_events, 
                              "Total Injuries" = total_injuries, 
                              "Total Fatalities" = total_fatalities, 
                              "Total Related" = total_health_related)
                       , add_colnames = TRUE) %>%
    set_bold(1,,TRUE) %>%
    set_all_borders(,,1) %>%
	set_align(,2:ncol(health_data),"center")

number_format(health_table) <- 0
health_table
```
And if we visualize those totals in a plot, we see a large difference between tornados and other types of events.
```{r health_plot, results="asis"}
health_long <- gather(health_data, 
                      health_type, 
                      total_amount, 
                      total_injuries:total_fatalities, 
                      factor_key = TRUE)

health_plot <- ggplot(health_long, aes(x = event_type, y = total_amount, fill=health_type)) +
    geom_bar(stat = "identity") +
    scale_fill_discrete(name = "Incident",
                        breaks = c("total_injuries", "total_fatalities"),
                        labels = c("Injuries", "Fatalities")) +
    xlab("Event Type") +
    ylab("Total Amount")

print(health_plot)
```
